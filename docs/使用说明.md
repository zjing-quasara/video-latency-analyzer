# 视频延时分析工具 - 使用说明

## 📖 快速开始

### 1. 启动程序

双击 `main.py` 或运行：
```bash
python main.py
```

### 2. 基本流程

1. **选择视频** → 点击"选择视频"按钮
2. **标定 T_app** → 点击"标定 T_app"，调整蓝框框选时间
3. **开始分析** → 点击"开始分析"（默认处理前300帧）
4. **查看报告** → 点击"打开 HTML 报告"

## ⚙️ 性能设置

### GPU 加速（默认启用）
- ✅ **已勾选"使用 GPU 加速"**
- GPU可提升OCR速度 3-10倍
- 如果没有NVIDIA显卡或CUDA，会自动降级到CPU

### OCR 分辨率
- **50% (最快)** - 默认，速度快，准确度高
- **75% (平衡)** - 速度中等，准确度更高
- **100% (最清晰)** - 速度慢，准确度最高

## 📊 分析参数

### 抽帧间隔
选择视频分析的采样频率：
- **每1帧** - 全采样，数据最密集，速度最慢
- **每3帧** - 高采样率
- **每5帧（推荐）** - 平衡数据密度和速度
- **每10帧** - 低采样率，速度快
- **每15帧** - 最快，但数据点较少

**说明**：抽帧间隔越大，处理速度越快，但延时曲线的数据点越少

### 分析模式
- **调试分析（默认）**：
  - 仅分析前100帧
  - 快速测试，验证ROI是否正确
  - 适合首次使用或调试

- **全量分析**：
  - 分析整个视频
  - 生成完整报告
  - 耗时较长，根据视频长度和设置而定

**推荐流程**：
1. 先用"调试分析"验证ROI设置是否正确
2. 确认无误后，切换到"全量分析"生成完整报告

## 📂 输出文件

### 默认位置
```
C:\Users\你的用户名\Desktop\视频延时分析\
```

### 文件结构
```
视频名_20251212_143000\          (报告文件夹)
  ├── 视频名_20251212_143000.html  (交互式报告)
  ├── 视频名_20251212_143000.csv   (原始数据)
  └── 视频名_20251212_143000.mp4   (标定视频)
```

## 📊 HTML报告使用

### 交互功能
- **左侧视频**：显示标定结果
  - 蓝框 = T_app（应用时间）
  - 绿框 = T_real（真实时间）
  - 红字 = 延时

- **右侧曲线**：延时趋势
  - 鼠标悬停 → 视频自动跳转到对应帧
  - 点击固定显示

- **数据表格**：详细信息
  - 鼠标悬停 → 视频自动跳转
  - 点击固定显示

## 🔧 常见问题

### Q1: 出现"PyQt5平台插件"错误？

**错误信息**：
```
qt.qpa.plugin: Could not find the Qt platform plugin "windows"
```

**解决方案**：
```bash
pip uninstall PyQt5 PyQt5-Qt5 -y
pip cache purge
pip install PyQt5==5.15.10
```

### Q2: 提示"PaddleOCR未安装"？

**解决方案**：
```bash
pip install paddleocr==2.7.3
```

### Q3: GPU加速不工作？

**检查步骤**：
1. 确认有NVIDIA显卡：运行 `nvidia-smi`
2. 安装CUDA版本PaddlePaddle：
```bash
python -m pip install paddlepaddle-gpu -i https://mirror.baidu.com/pypi/simple
```

3. 查看日志确认GPU状态

### Q4: 识别不出T_real？

**可能原因**：
- T_real区域太暗或太亮
- 时间格式不标准

**解决方案**：
1. 在 `config.py` 中调整 `ROI_DETECTION['threshold']`
2. 查看 `data/debug/` 目录的调试图片

### Q5: 时间倒退警告？

**说明**：
这是正常的！系统检测到OCR识别错误（时间比前一帧还早），自动过滤。

**日志示例**：
```
⚠️ 帧 15: T_real时间倒退 (22:00:34.315 < 上一帧)，标记为识别失败
```

## 📋 日志系统

### 日志位置
```
logs\
  └── app_20251212_143000.log  (每次运行生成新日志)
```

### 打开日志
点击界面底部的 **"打开日志文件"** 按钮

### 日志内容
```
[2025-12-12 14:30:00] INFO [Main.main:25] 正在启动应用...
[2025-12-12 14:30:00] INFO [Main.main:30] ✓ OpenCV 4.8.1
[2025-12-12 14:30:01] INFO [Main.main:37] ✓ PaddleOCR 2.7.3
[2025-12-12 14:30:01] INFO [Main.main:44] ✓ PyQt5 5.15.10
[2025-12-12 14:30:05] INFO [AnalysisWorker.run:45] 开始视频分析任务
[2025-12-12 14:30:05] INFO [AnalysisWorker.run:50] OCR GPU模式: 启用
[2025-12-12 14:30:08] INFO [AnalysisWorker.analyze_video:120] 帧 0: 延时=1022ms
```

### 发送日志给开发者
如果遇到问题：
1. 点击"打开日志文件"
2. 复制完整日志内容
3. 发送给开发者

## 🎯 高级配置

### 修改默认帧数限制
编辑 `config.py`：
```python
DEFAULT_FRAME_LIMIT = 300  # 改为想要的帧数
```

### 修改ROI检测参数
编辑 `config.py` 中的 `ROI_DETECTION`：
```python
'threshold': 30,        # 二值化阈值（降低=检测更暗的区域）
'min_area_ratio': 0.05, # 最小面积比例
'max_area_ratio': 0.5,  # 最大面积比例
```

### 修改输出路径
在GUI中点击"选择输出路径"，或编辑 `config.py`：
```python
DEFAULT_OUTPUT_DIR = Path.home() / "Desktop" / "视频延时分析"
```

## 💡 使用技巧

### 1. 提高识别准确度
- 使用高分辨率视频
- 确保时间区域清晰可见
- 选择 100% OCR分辨率（速度会变慢）

### 2. 加快处理速度
- 启用GPU加速
- 选择 50% OCR分辨率
- 增大 `DEFAULT_FRAME_STEP`（跳帧步长）

### 3. 批量处理
- 标定一次ROI后，配置会自动保存
- 后续视频无需重新标定（如果位置相同）

## 📞 技术支持

### 获取帮助
1. 查看 `README.md`
2. 查看 `docs/时间单调性验证.md`
3. 发送日志文件给开发者

### 反馈问题
提供以下信息：
- 系统版本（Windows 10/11）
- Python版本
- 完整日志文件（`logs/app_*.log`）
- 错误截图

---

**版本**: v1.2.0  
**更新日期**: 2025-12-12

