# 时间单调性验证功能

## 功能说明

在视频分析过程中，OCR可能会偶尔识别错误，导致识别出的时间戳比前一帧还早（时间倒退）。这在物理上是不可能的，因此可以判断为识别错误。

本功能会自动检测并过滤这些错误，提高分析结果的准确性。

## 工作原理

1. **记录上一帧时间**：分析器会记录上一帧成功识别的 T_app 和 T_real 时间戳（单位：毫秒）

2. **单调性检查**：对于当前帧识别出的时间戳
   - 如果 T_app < 上一帧的 T_app → 标记为识别失败
   - 如果 T_real < 上一帧的 T_real → 标记为识别失败

3. **过滤错误数据**：被标记为识别失败的时间戳会被设置为 `None`，不参与延时计算

4. **日志记录**：在日志中显示警告信息，方便追踪

## 示例

```
正常序列：
  帧 0: T_app=22:00:35.605, T_real=22:00:34.583 ✓
  帧 5: T_app=22:00:35.766, T_real=22:00:34.781 ✓
  帧 10: T_app=22:00:35.855, T_real=22:00:34.909 ✓

检测到错误：
  帧 0: T_app=22:00:35.605, T_real=22:00:34.583 ✓
  帧 5: T_app=22:00:35.766, T_real=22:00:34.315 ⚠️ T_real时间倒退，标记为识别失败
  帧 10: T_app=22:00:35.840, T_real=22:00:34.781 ⚠️ T_app时间倒退，标记为识别失败
  帧 15: T_app=22:00:36.026, T_real=22:00:34.999 ✓
```

## 日志输出

当检测到时间倒退时，日志会显示：

```
⚠️ 帧 5: T_real时间倒退 (22:00:34.315 < 上一帧)，标记为识别失败
⚠️ 帧 10: T_app时间倒退 (22:00:35.840 < 上一帧)，标记为识别失败
```

## 技术实现

位置：`core/analyzer.py` 的 `analyze_video()` 方法

```python
# 记录上一帧时间戳
last_app_time_ms = None
last_real_time_ms = None

# 在每一帧处理时
if app_time_ms is not None and last_app_time_ms is not None:
    if app_time_ms < last_app_time_ms:
        # 时间倒退，标记为失败
        app_time_ms = None
        
# 更新上一帧时间（只有有效时才更新）
if app_time_ms is not None:
    last_app_time_ms = app_time_ms
```

## 优势

1. **自动过滤错误**：无需手动检查数据，自动提升准确性
2. **透明可追踪**：所有过滤操作都记录在日志中
3. **零配置**：无需额外设置，开箱即用
4. **精确检测**：基于物理规律（时间单调递增）的硬约束

## 限制

- 仅能检测时间倒退错误，无法检测其他类型的OCR错误（如识别错一个数字）
- 如果连续多帧都识别错误，可能会漏掉一些正确的帧

## 测试

运行单元测试验证功能：

```python
# 见 core/analyzer.py 中的实现
# 已通过自动化测试验证
```

---

**版本**: v1.2.0  
**日期**: 2025-12-12

